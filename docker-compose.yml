version: '3.9'

services:
  keycloak-db:
    image: postgres:16
    container_name: keycloak-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: admin
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: keycloak
    restart: unless-stopped
    command: ["start-dev"]
    environment:
      # Admin user to log into Keycloak console
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin

      # Database config
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: admin

      # HTTP settings
      KC_HTTP_PORT: 8080
      # In dev we usually run without HTTPS; handled by reverse proxy in prod
    ports:
      - '8080:8080'
    depends_on:
      - keycloak-db

  # ----------------------------------------------------------------------------
  # GeoGN traffic / road-graph stack (désactivée par défaut)
  # Décommente et adapte ces services si tu souhaites tout lancer via
  # docker-compose. Pour l'instant ils sont fournis uniquement à titre
  # documentaire, afin d'expliquer l'architecture attendue.
  #
  # backend:
  #   build: ./backend
  #   depends_on:
  #     - mongo
  #     - road-graph
  #   environment:
  #     - TRAFFIC_PROVIDER=tomtom
  #     - TOMTOM_API_KEY=changeme
  #
  # frontend:
  #   build: ./frontend
  #   depends_on:
  #     - backend
  #
  # mongo:
  #   image: mongo:7
  #   volumes:
  #     - mongo-data:/data/db
  #
  # road-graph:
  #   image: your-org/road-graph:latest
  #   # Ce microservice wrappe OSRM/Valhalla et expose:
  #   #   GET /snap?lng=&lat=&profile=
  #   #   GET /tile?z=&x=&y=&profile=
  #   environment:
  #     - ROAD_GRAPH_ENGINE=osrm
  #     - OSRM_BASE_URL=http://osrm-backend:5000
  #   depends_on:
  #     - osrm-backend
  #
  # osrm-backend:
  #   image: osrm/osrm-backend
  #   command: "osrm-routed /data/region.osrm"
  #   volumes:
  #     - ./data/osrm:/data

volumes:
  keycloak-db-data:
  # mongo-data:
